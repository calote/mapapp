<!DOCTYPE html>
<html lang="en">
<head>
<title>OpenCPU Country Mapping App</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<!-- ocpu library -->
<script src="jquery/jquery-1.9.1.js"> </script>
<script src="opencpu/opencpu.js"> </script>

<!-- some optional styling stuff -->
<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
<link href="bootstrap/css/bootstrap-theme.min.css" rel="stylesheet" media="screen">

<link href="jqueryui/css/ui-lightness/jquery-ui-1.10.3.custom.css" rel="stylesheet" media="screen">

<script src="bootstrap/js/bootstrap.js"> </script>
<script src="jqueryui/jquery-ui-1.10.3.custom.js"> </script>

<script> 
$(document).ready(function() {
  
  //globals
  var mydata;
  var mapdata;
  
  $("#csvfile").on("change", function(){
    
    //verify that a file is selected
    if(!$("#csvfile")[0].files[0]) return;
    
    //call uploaddata function
    var req = opencpu.r_fun_call("uploaddata", {
      csvfile : $("#csvfile")[0].files[0]    
    }, function(tmp){
      mydata = tmp;
      datainfo();
    }).fail(function(){
      alert(req.responseText);
    });
  });
  
  function datainfo(){
    opencpu.r_fun_json("datainfo", {mydata : mydata}, function(jsondata){
      $.each(jsondata.strings, function(i, val){
        $("<option>").text(val).appendTo("#nameJoinColumn");
      });
      $.each(jsondata.all, function(i, val){
        $("<option>").text(val).appendTo("#nameColumnToPlot");
      });      
    });
  }
  
  $("#datafields select").on("change", function(){
    opencpu.r_fun_call("join", {
      dF : mydata, 
      nameJoinColumn : $("#nameJoinColumn").val(),
      joinCode : $("#joinCode").val()
    }, function(tmp){
      mapdata = tmp;      
    });
  });
  
  $("#mapfields select").on("change", function(){
    $("#plotdiv").r_fun_plot("map", {
      mapToPlot : mapdata, 
      nameColumnToPlot : $("#nameColumnToPlot").val(),
      mapRegion : $("#mapRegion").val()
    });
  });  
    
  $("#plotdiv").resizable();
    
});
</script>
<style>

#plotdiv {
  width: 100%;
  height: 600px;
  border: 1px solid #e3e3e3;
  border-radius: 4px;
}

#csvfile{
  max-width: 197px;
}

button{
  float: right;
  width: 100px;
  margin-right: 20px;
}

</style>
</head>

<body>
<div class="container">
  <div class="page-header">
    <h1>Country Map App</h1>
  </div>
    
  <div class="row">
    <div class="col-lg-3">
      <div class="well">
        <form role="form" id="uploadform" enctype="multipart/form-data">
          <fieldset>
            <legend>(1) Upload Data</legend>
            
              <div class="form-group">
                 <input type="file" id="csvfile">
                <p class="help-block">Upload a CSV data file.</p>
              </div>
              
          </fieldset>         
          
          <fieldset id="datafields">
            <legend>(2) Merge Data</legend>
            
            <div class="form-group">
              <label>Country Column</label>
              <select class="form-control" id="nameJoinColumn">        
              </select>    
            </div>
            
            <div class="form-group">
              <label>Join Code</label>
              <select class="form-control" id="joinCode">
                <option>ISO2</option>
                <option selected="selected">ISO3</option>
                <option>FIPS</option>
                <option>NAME</option>
                <option>UN</option>
              </select>    
            </div>   

          </fieldset>         
          
          <fieldset id="mapfields">
            <legend>(3) Create Map</legend>            
            
            <div class="form-group">
              <label>Plot Column</label>
              <select class="form-control" id="nameColumnToPlot">
              </select>   
            </div>
            
            <div class="form-group">
              <label>Map Region</label>
              <select class="form-control" id="mapRegion">
                <option selected="selected">world</option>
                <option>africa</option>
                <option>oceania</option>
                <option>eurasia</option>
                <option>uk</option>
              </select>    
            </div>    
            
          </fieldset>
        </form>
        
        <br />
     
      </div>
    </div>
    
    <div class="col-lg-9">
      <div id="plotdiv"></div>
    </div>  
  </div>
</div>
</body>
</html>
